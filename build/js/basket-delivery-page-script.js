"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var n=[],r=!0,i=!1,o=void 0;try{for(var a,c=e[Symbol.iterator]();!(r=(a=c.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){i=!0,o=e}finally{try{r||null==c.return||c.return()}finally{if(i)throw o}}return n}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var n=null==arguments[t]?{}:arguments[t],r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(t){_defineProperty(e,t,n[t])})}return e}function asyncGeneratorStep(e,t,n,r,i,o,a){try{var c=e[o](a),u=c.value}catch(e){return void n(e)}c.done?t(u):Promise.resolve(u).then(r,i)}function _asyncToGenerator(e){return function(){var t=this,n=arguments;return new Promise(function(r,i){function o(e){asyncGeneratorStep(c,r,i,o,a,"next",e)}function a(e){asyncGeneratorStep(c,r,i,o,a,"throw",e)}var c=e.apply(t,n);o(void 0)})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var ShiptorPointsGetter=function e(t){var n=this,r=t.usersCity,i=t.fromCity;_classCallCheck(this,e),_defineProperty(this,"_escapeHtml",function(e){var t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,function(e){return t[e]})}),_defineProperty(this,"_getData",function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,fetch("https://api.shiptor.ru/public/v1",{method:"POST",headers:{"Content-Type":"application/json"},body:t}).then(function(e){return e.json()});case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}},e)}));return function(){return e.apply(this,arguments)}}()),_defineProperty(this,"getDeliveryPoints",_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,i,o=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=0<o.length&&void 0!==o[0]?o[0]:{},(r=t.courier)&&(r={courier:r}),i=n._dataHandler({method:"getDeliveryPoints",params:_objectSpread({kladr_id:"".concat(n.usersCityKladr),cod:"0"},r)}),e.next=5,n._getData(i);case 5:return e.abrupt("return",e.sent);case 6:case"end":return e.stop()}},e)}))),_defineProperty(this,"getUsersCityKladr",_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=n._dataHandler({method:"suggestSettlement",params:{query:n.usersCity,country_code:"RU"}}),e.next=3,n._getData(t);case 3:r=e.sent;try{n.usersCityKladr=r.result[0].kladr_id}catch(e){n.usersCityKladr="00000000000"}return e.abrupt("return",r);case 6:case"end":return e.stop()}},e)}))),_defineProperty(this,"calculateShipping",_asyncToGenerator(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=n._dataHandler({method:"calculateShipping",params:{kladr_id:"".concat(n.usersCityKladr),kladr_id_from:"76000001000",cod:"0",length:10,width:10,height:10,weight:1,declared_cost:0}}),e.next=3,n._getData(t);case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}},e)}))),_defineProperty(this,"_dataHandler",function(e){var t=_.clone(n.cityData);return JSON.stringify(_.extend(t,e))}),this.usersCity=this._escapeHtml(r),this.fromCity=i,this.cityData={id:"JsonRpcClient.js",jsonrpc:"2.0",method:""}};window.deliveryPickup=function(){var e=function(){var e=getCookie("deliveryCity"),t=window.citiesList.filter(function(t){return t.branches&&t.name===e}).flatMap(function(e){e.name;return e.branches}).flatMap(function(e){var t=e.name,n=_slicedToArray(t.split(", "),1)[0],r=t.split(", ");return r.shift(),[[n,r.join(", ")]]});return{city:t[0]?t.map(function(e){return e[0]}):"К сожалению, в данном городе у нас нет филиалов :(",address:t[0]?t.map(function(e){return e[1]}):'Выберите Пункт доставки в разделе "Доставка"'}}(),t={pickupModule:document.querySelector(".delivery-pickup")};!function(e){var t=function(e){localStorage.setItem("deliveryDate","0"),localStorage.setItem("deliveryAddress","pickup: ".concat(e))},n=function(e){var t=e.pickupModule,r=e.pointsWrapper,i=e.deliveryPoints,o=e.chosenCity;return n.initiate=function(){var e=function(t,n,r,i){var o,a,c=!1;return e.checkRender=function(){return c=t.dataset.rendered,e},e.fillModule=function(){return c||(Array.isArray(r)?r.city.forEach(function(e,t){return n.append(function(e,t){var n=document.createElement("p");return n.classList.add("delivery-pickup__point"),n.textContent="".concat(e,", ").concat(t),n}(e,r.address[t]))}):n.append(function(e,t){var n=document.createElement("p");return n.classList.add("delivery-pickup__no-point"),n.innerHTML="".concat(e,"<br/>").concat(t),n}(r.city,r.address)),t.dataset.rendered="1"),e},e.getUserCity=function(){return o=i.textContent,e},e.setUserCity=function(){return o?a=o:(a=getCookie("deliveryCity")||YMaps.location.city||"Ярославль",h.setText(i,a)),e},e};return e(t,r,i,o).checkRender().fillModule().getUserCity().setUserCity(),n},n},r=function(e){var n,i,o,a=e.input,c=e.pointsWrapper,u=e.pickupModule,s=e.changeCity,l=function(){},d=function(){},p=function(){},f=function(){},y=[],v=u.dataset.deliveryPoint||"";return r.create=function(){return l=function(e){var t=h.escapeHtml(e.target.value),r=function(e){var t,o=function(e){return e.toLowerCase()};return r.getAllPoints=function(){return n=n||_toConsumableArray(c.querySelectorAll(".delivery-pickup__point")),r},r.inputString=function(){return 3>e.length?i?(r.filterPoints("remove"),i=!1,t=!0,r):(t=!0,r):(e=o(e),r)},r.filterPoints=function(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"add";return t?r:(_toConsumableArray(n).forEach(function(t){var n=o(t.textContent);return 0<e.length&&~n.indexOf(e)?void h.handleClass(t,"remove","hidden"):(h.handleClass(t,a,"hidden"),void(i=!0))}),r)},r};r(t).getAllPoints().inputString().filterPoints()},l=_.debounce(l,300),d=function(e){var n=function(e){var r,i,a,s=e.target,l=function(){return l.setFastExit=function(e){return r=e,l},l.setSelected=function(e){return a=e,l},l.setPrevEl=function(e){return i=e,l},l.clearSavedInfo=function(){return h.setDataSet(u,"deliveryPoint",""),localStorage.setItem("deliveryAddress",""),localStorage.setItem("deliveryDate",""),h.saveAllCookie({type:null,address:null,id:null,deadline:null,cost:null,courier:null}),l},l.clearChosenPoint=function(){return h.removeElement(o),l},l.setChosenPoint=function(){return v=s.textContent,h.setDataSet(u,"deliveryPoint",v),l},l.saveStorageInfo=function(){return t(v),h.saveAllCookie({type:"pickup",address:v,id:"",deadline:"0",cost:"0",city:v.split(",")[0]}),l},l};return n.checkEl=function(){return s.classList.contains("delivery-pickup__point")?(s.classList.contains("delivery-pickup__point--active")?l().setFastExit(!0).setSelected(!0):l().setPrevEl(c.querySelector(".delivery-pickup__point--active")),n):(l().setFastExit(!0),n)},n.saveInfo=function(){return a?(l().clearSavedInfo().clearChosenPoint(),n):(r||l().setChosenPoint().saveStorageInfo(),n)},n.setStatus=function(){return r||h.handleClass(s,"add","delivery-pickup__point--active"),a&&h.handleClass(s,"remove","delivery-pickup__point--active"),i&&h.handleClass(i,"remove","delivery-pickup__point--active"),n},n};n(e).checkEl().saveInfo().setStatus()},p=function(){var e=function(){return e.restorePoints=function(){return _toConsumableArray(c.children).forEach(function(e){return h.handleClass(e,"remove","hidden")}),e},e.hide=function(){return h.handleClass(u,"add","hidden"),e},e.inputClear=function(){return a.value="",e},e.removeListeners=function(){return y.forEach(function(e){return function(e,t,n){return e.removeEventListener(t,n)}(e[0],e[1],e[2])}),e},e.disableBlockScreen=function(){return h.handleClass(blockScreen,"add","hidden"),e},e.blockConfirmButton=function(){return e},e.callCustomEvent=function(){return u.dispatchEvent(customEvent),e},e};e().hide().restorePoints().inputClear().removeListeners().blockConfirmButton().disableBlockScreen().callCustomEvent()},function(){var e=function(){return e.closeModule=function(){return p(),e},e.saveInfo=function(){return t(v),e},e};e().saveInfo().closeModule()},f=function(){sessionStorage.setItem("fromBasket","y"),sessionStorage.setItem("prevBasketPage","2"),location.assign("/kontakty.html")},r},r.add=function(){return(y=[[a,"input",l],[c,"click",d],[s,"click",f]]).forEach(function(e){return function(e,t,n){return e.addEventListener(t,n)}(e[0],e[1],e[2])}),r},r};n(e).initiate(),r(e).create().add()}(_.extend(t,{pointsWrapper:t.pickupModule.querySelector(".delivery-pickup__points-list"),input:t.pickupModule.querySelector(".delivery-pickup__input"),chosenCity:t.pickupModule.querySelector(".delivery-pickup__chosen-city"),changeCity:t.pickupModule.querySelector(".delivery-pickup__change-city"),deliveryPoints:e}))},window.deliverySelfExport=function(){var e={selfExportModule:document.querySelector(".delivery-selfExport"),JCShiptorWidgetPvz:document.querySelector("#shiptor_widget_pvz"),map:document.querySelector('[data-role="shiptor_widget_show"]')};!function(e){var t={onChangeCity:function(){},onShowMapClick:function(){},onPickupConfirm:function(){},onPickupInput:function(){},onPickupPointClick:function(){},onCloseClick:function(){},onMapClose:function(){}},n=function(e,t,n){localStorage.setItem("deliveryDate",h.getDataSet(e,"deliveryPeriod")),localStorage.setItem("deliveryAddress","delivery: ".concat(t," | ").concat(n))},r=function(e){var t,n,r=e.result.methods;try{t=r[0].min_days}catch(e){var i=e.message;console.log(i),t=0}try{n=r[0].max_days}catch(e){var o=e.message;console.log(o),n=0}return[t,n]},i=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"77000000000";return new ShiptorPointsGetter({usersCity:e,fromCity:t})},o=function(e){var t=e.itemList,n=e.childClassName,r=e.wrapper,i=e.fastExit,o=e.isCityFiltered,a=e.firstInitiate,c=!(void 0!==a)||a;return function(e){var a=h.escapeHtml(e.target.value),u=function(e){var a;return u.initiate=function(){return c&&(t="pickup"===t?r.querySelector(".delivery-selfExport__pickup-list"):r.querySelector(".delivery-selfExport__cities-list")),c=!1,u},u.getAllPoints=function(){return a=_toConsumableArray(t.querySelectorAll(n)),u},u.inputString=function(){return 3>e.length?o?(u.filterPoints("remove"),o=!1,i=!0,u):(i=!0,u):(e=h.lowerCase(e),u)},u.filterPoints=function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"add";return i?u:(a.forEach(function(n){var r=n.dataset.value;return h.checkSubString(r,e)?void h.handleClass(n,"remove","hidden"):(h.handleClass(n,t,"hidden"),void(o=!0))}),u)},u.clearClosure=function(){return i="",u},u};u(a).initiate().getAllPoints().inputString().filterPoints().clearClosure()}},a=function(e){var t=e.selfExportModule,n=e.pickupList,o=e.chosenCity,c=e.pickupSection,u=e.pickupSearchInput,s=e.JCShiptorWidgetPvz,l=e.waitScreen;return a.initiate=function(){var e=function(){var a,d,p,f,y=!1,v=+localStorage.getItem("needRerender");return e.showPickupSection=function(){return h.show(c),e},e.setWaitScreen=function(){return h.setWaitScreen(l),e},e.getUserCity=function(){return a=o.textContent,e},e.setUserCity=function(){return a?d=a:(d=getCookie("deliveryCity")||YMaps.location.city||"Ярославль",h.setText(o,d)),e},e.checkRender=function(){var n=function(){return n.getRenderedPoints=function(){return y=h.getDataSet(t,"renderedPoints"),n},n.getRenderedCity=function(){return a!==h.getDataSet(t,"renderedCity")&&(a=""),n},n.setRenderedCity=function(){return h.setDataSet(t,"renderedCity",d),n},n};return n().getRenderedCity().getRenderedPoints().setRenderedCity(),e},e.handleDeliveryPoints=function(){if(!y||!a||v){var o=function(){return o.clearLocalRerenderInfo=function(){return localStorage.setItem("needRerender",""),v=!1,o},o.cleaPickupInput=function(){return h.clearInput(u),o},o.clearPickupList=function(){return h.clearEl(n),o},o.initiateApi=function(){return f=i(d,"77000000000"),o},o.handleRequest=function(){f.getUsersCityKladr().then(function(e){var n;try{n=e.result[0].kladr_id}catch(e){var r=e.message;console.log(r),n="11001110011"}return h.setDataSet(t,"cityKladr",n),n}).then(function(e){return h.setDataSet(s,"cityKladr",e)}).then(function(e){return o.setKladrId(e)}).then(function(){return window.JCShiptorWidgetPvz.hide()}).then(function(){return f.calculateShipping()}).then(function(e){var n=_slicedToArray(r(e),2),i=n[0],o=n[1];[i+0,o+0],h.setDataSet(t,"deliveryPeriod",o||i)}).then(function(){f.getDeliveryPoints().then(function(e){return 1>e.result.length&&h.showError(),o.filterPoints(e)}).then(function(){h.setDataSet(t,"renderedPoints",1),e.checkRender(),a=d}).then(function(){return e.disableWaitScreen(l)})})},o.filterPoints=function(e){var t=e.result;return p=t.filter(function(e){return e.active}),o.renderDeliveryPoints(p),o},o.renderDeliveryPoints=function(e){var t=function(e){var t=e.courier,n=e.address,r=e.prepare_address,i=e.id,o=function(e,t){var n,r,i;try{"object"===_typeof(e=e||t)?(n=e.street,r=e.house,i="".concat(n," ").concat(r)):(i=(i=t).split(", "),i="".concat(i[1]," ").concat(i[2]))}catch(e){}return i}(r,n),a=document.createElement("li");h.handleClass(a,"add","delivery-selfExport__pickup-point"),h.setDataSet(a,"value",o),h.setDataSet(a,"id",i),h.setDataSet(a,"courier",t);var c=document.createElement("p");return h.handleClass(c,"add","delivery-selfExport__address"),h.setText(c,n),a.append(c),a},r=document.createDocumentFragment();e.forEach(function(e){r.append(t(e))}),n.append(r)},o.setKladrId=function(e){return window.JCShiptorWidgetPvz.setParams({location:{kladr_id:e}}),window.JCShiptorWidgetPvz.refresh(),o},o};return o().clearLocalRerenderInfo().cleaPickupInput().clearPickupList().initiateApi().handleRequest(),e}return e.disableWaitScreen(l),e},e.disableWaitScreen=_asyncToGenerator(regeneratorRuntime.mark(function t(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,h.disableWaitScreen(l);case 2:return t.abrupt("return",e);case 3:case"end":return t.stop()}},t)})),e};e().showPickupSection().setWaitScreen().getUserCity().setUserCity().checkRender().handleDeliveryPoints()},a},c=function(e){var r=e.changeCity,i=e.showMap,a=e.pickupSection,u=e.citiesList,s=e.selfExportModule,l=e.citiesSection,d=e.pickupSearchInput,p=e.pickupList,f=e.JCShiptorWidgetPvz,y=e.map,v=[],m="".concat(s.dataset.renderedCity,", ").concat(s.dataset.deliveryPoint)||"",C=h.getDataSet(p.querySelector(".delivery-selfExport__pickup-point--active"),"courier"),S=new Event("ClosePickupModule",{bubbles:!0});return c.create=function(){return t.onChangeCity=function(){sessionStorage.setItem("fromBasket","y"),sessionStorage.setItem("prevBasketPage","2"),location.assign("/kontakty.html")},t.onPickupInput=_.partial(o,{itemList:"pickup",childClassName:".delivery-selfExport__pickup-point",wrapper:s}),t.onPickupInput=_.debounce(t.onPickupInput(),300),t.onPickupPointClick=function(e){var t=function(e){var r,i,o,a=e.target,c=function(){return c.setFastExit=function(e){return r=e,c},c.setSelected=function(e){return o=e,c},c.setPrevEl=function(e){return i=e,c},c.clearSavedInfo=function(){return h.setDataSet(s,"deliveryPoint",null),h.clearStorage(["deliveryDate","deliveryAddress"]),h.saveAllCookie({type:null,address:null,id:null,deadline:null,cost:null,courier:null}),c},c.clearChosenPoint=function(){return h.removeElement(void 0),c},c.setChosenPoint=function(){return m=a.querySelector(".delivery-selfExport__address").textContent,C=h.getDataSet(a,"courier"),h.setDataSet(s,"deliveryPoint",h.getDataSet(a,"value")),c},c.setStorageInfo=function(){return n(s,m,C),h.saveAllCookie({type:"selfExport",address:m,id:h.getDataSet(a,"id"),deadline:s.dataset.deliveryPeriod,cost:window.citiesList[0].price,courier:C}),c},c};return t.checkEl=function(){var e=h.lowerCase(a.tagName);return"li"!==e&&"p"!==e?(c().setFastExit(!0),t):("p"===e&&(a=a.parentElement),a.classList.contains("delivery-selfExport__pickup-point--active")?c().setFastExit(!0).setSelected(!0):c().setPrevEl(p.querySelector(".delivery-selfExport__pickup-point--active")),t)},t.saveInfo=function(){return o?(c().clearSavedInfo().clearChosenPoint(),t):(r||c().setChosenPoint().setStorageInfo(),t)},t.setStatus=function(){return r||h.handleClass(a,"add","delivery-selfExport__pickup-point--active"),o&&h.handleClass(a,"remove","delivery-selfExport__pickup-point--active"),i&&h.handleClass(i,"remove","delivery-selfExport__pickup-point--active"),t},t};t(e).checkEl().saveInfo().setStatus()},t.onCloseClick=function(){var e=function(){return e.restorePoints=function(){return _toConsumableArray(p.children).forEach(function(e){return h.handleClass(e,"remove","hidden")}),e},e.hide=function(){return[s,a,l].forEach(h.hide),e},e.inputClear=function(){return d.value="",e},e.showAllCities=function(){return h.showAll(u.children),e},e.removeListeners=function(){return h.removeListOfEvents(v,"closeModule"),e},e.callCustomEvent=function(){return s.dispatchEvent(S),e},e};e().hide().restorePoints().inputClear().showAllCities().removeListeners().callCustomEvent()},t.onPickupConfirm=function(){n(s,m,C),t.onCloseClick()},t.onShowMapClick=function(){var e=function(){return e.mapCall=function(){return y.click(),e},e};e().mapCall()},t.onMapClose=function(e){var n=function(){return n.handleData=function(e){var r=e.detail.address,i=function(){var e;return i.handleGettedAddress=function(){return r=h.lowerCase(r),i},i.getChosenPickupFromList=function(){return e=_toConsumableArray(p.children).filter(function(e){var t=h.lowerCase(e.querySelector(".delivery-selfExport__address").textContent);return h.isMatch(t,r)}),i},i.handleChosenPoint=function(){return e?(e=e[0],t.onPickupPointClick({target:e}),i):void alert("Автоматически пункт выдачи не найден :( \n Попробуйте самостоятельно найти в списке")},i.sortPickupList=function(){return e.remove(),p.prepend(e),i},i.clearPreviousSearch=function(){return t.onPickupInput({target:{value:""}}),i},i};return i().handleGettedAddress().getChosenPickupFromList().handleChosenPoint().sortPickupList().clearPreviousSearch(),n},n};n().handleData(e)},c},c.listInitiate=function(){return v=[{element:r,ev:"click",listener:t.onChangeCity,changeCityRemove:!0,cityConfirmAdd:!0,boot:!0},{element:i,ev:"click",listener:t.onShowMapClick,changeCityRemove:!0,cityConfirmAdd:!0,boot:!0},{element:d,ev:"input",listener:t.onPickupInput,changeCityRemove:!0,cityConfirmAdd:!0,boot:!0},{element:p,ev:"click",listener:t.onPickupPointClick,changeCityRemove:!0,cityConfirmAdd:!0,boot:!0},{element:f,ev:"onPvzSelect",listener:t.onMapClose,boot:!0}],c},c.add=function(){return h.addListOfEvents(v,"boot"),c},c};a(e).initiate(),c(e).create().listInitiate().add()}(_.extend(e,{citiesList:e.selfExportModule.querySelector(".delivery-selfExport__cities-list"),pickupList:e.selfExportModule.querySelector(".delivery-selfExport__pickup-list"),pickupSection:e.selfExportModule.querySelector(".delivery-selfExport__pickup"),citiesSection:e.selfExportModule.querySelector(".delivery-selfExport__cities"),citySearchInput:e.selfExportModule.querySelector(".delivery-selfExport__city-search-input"),pickupSearchInput:e.selfExportModule.querySelector(".delivery-selfExport__pickup-search-input"),errorSection:e.selfExportModule.querySelector(".delivery-selfExport__error"),waitScreen:e.selfExportModule.querySelector(".delivery-selfExport__wait-screen"),chosenCity:e.selfExportModule.querySelector(".delivery-selfExport__chosen-city"),changeCity:e.selfExportModule.querySelector(".delivery-selfExport__change-city"),showMap:e.selfExportModule.querySelector(".delivery-selfExport__show-map")}))};