"use strict";function _objectSpread(e){for(var t=1;t<arguments.length;t++){var i=null==arguments[t]?{}:arguments[t],r=Object.keys(i);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(i).filter(function(e){return Object.getOwnPropertyDescriptor(i,e).enumerable}))),r.forEach(function(t){_defineProperty(e,t,i[t])})}return e}function _defineProperty(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class ShiptorPointsGetter{constructor({usersCity:e,fromCity:t}){_defineProperty(this,"_escapeHtml",e=>{const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,e=>t[e])}),_defineProperty(this,"_getData",async e=>await fetch("https://api.shiptor.ru/public/v1",{method:"POST",headers:{"Content-Type":"application/json"},body:e}).then(e=>e.json())),_defineProperty(this,"getDeliveryPoints",async({courier:e}={})=>{e&&(e={courier:e});const t=this._dataHandler({method:"getDeliveryPoints",params:_objectSpread({kladr_id:`${this.usersCityKladr}`,cod:"0"},e)});return await this._getData(t)}),_defineProperty(this,"getUsersCityKladr",async()=>{const e=this._dataHandler({method:"suggestSettlement",params:{query:this.usersCity,country_code:"RU"}});let t=await this._getData(e);try{this.usersCityKladr=t.result[0].kladr_id}catch(e){this.usersCityKladr="00000000000"}return t}),_defineProperty(this,"calculateShipping",async()=>{const e=this._dataHandler({method:"calculateShipping",params:{kladr_id:`${this.usersCityKladr}`,kladr_id_from:"76000001000",cod:"0",length:10,width:10,height:10,weight:1,declared_cost:0}});return await this._getData(e)}),_defineProperty(this,"_dataHandler",e=>{let t=_.clone(this.cityData);return JSON.stringify(_.extend(t,e))}),this.usersCity=this._escapeHtml(e),this.fromCity=t,this.cityData={id:"JsonRpcClient.js",jsonrpc:"2.0",method:""}}}window.deliveryPickup=(()=>{const e={pickupModule:document.querySelector(".delivery-pickup")};(e=>{const t={saveAllCookie:(e,t,i,r,o,l="")=>{const s=["deliveryType","deliveryAddress","selfExportPointId","deliveryDeadline","deliveryCost","deliveryCity"];[e,t,i,r,o,l].forEach((e,t)=>null===e?void saveCookie(s[t],""):void(!e||saveCookie(s[t],e)))},handleClass:(e,t,i)=>e.classList[t](i),escapeHtml:e=>{const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,e=>t[e])},activateButton:e=>{e.disabled=!1,t.handleClass(e,"remove","delivery-pickup__confirm-btn--deactive")},disableButton:e=>{e.disabled=!0,t.handleClass(e,"add","delivery-pickup__confirm-btn--deactive")},setDataSet:(e,t,i)=>e.dataset[t]=i,clearEl:e=>null},i=e=>{localStorage.setItem("deliveryDate","0"),localStorage.setItem("deliveryAddress",`pickup: ${e}`)},r=({pickupModule:e,pointsWrapper:t,deliveryPoints:i})=>(r.initiate=(()=>{const o=(e,t,i)=>{let r=!1;return o.checkRender=(()=>(r=e.dataset.rendered,o)),o.fillModule=(()=>(r||(i.city.forEach((e,r)=>t.append(((e,t)=>{const i=document.createElement("p");return i.classList.add("delivery-pickup__point"),i.textContent=`${e}, ${t}`,i})(e,i.address[r]))),e.dataset.rendered="1"),o)),o};return o(e,t,i).checkRender().fillModule(),r}),r),o=({input:e,pointsWrapper:r,pickupModule:l})=>{let s,n,a,d=()=>{},c=()=>{},p=()=>{},u=()=>{},h=[],v=l.dataset.deliveryPoint||"";return o.create=(()=>(d=(e=>{const i=t.escapeHtml(e.target.value),o=e=>{const i=e=>e.toLowerCase();let l;return o.getAllPoints=(()=>(s=s||[...r.querySelectorAll(".delivery-pickup__point")],o)),o.inputString=(()=>3>e.length?n?(o.filterPoints("remove"),n=!1,l=!0,o):(l=!0,o):(e=i(e),o)),o.filterPoints=((r="add")=>l?o:([...s].forEach(o=>{const l=i(o.textContent);return 0<e.length&&~l.indexOf(e)?void t.handleClass(o,"remove","hidden"):(t.handleClass(o,r,"hidden"),void(n=!0))}),o)),o};o(i).getAllPoints().inputString().filterPoints()}),d=_.debounce(d,300),c=(e=>{const o=e=>{const{target:s}=e;let n,d,c;const p=()=>(p.setFastExit=(e=>(n=e,p)),p.setSelected=(e=>(c=e,p)),p.setPrevEl=(e=>(d=e,p)),p.clearSavedInfo=(()=>(t.setDataSet(l,"deliveryPoint",""),localStorage.setItem("deliveryAddress",""),localStorage.setItem("deliveryDate",""),t.saveAllCookie(null,null,null,null,null),p)),p.clearChosenPoint=(()=>(t.clearEl(a),p)),p.setChosenPoint=(()=>(v=s.textContent,t.setDataSet(l,"deliveryPoint",v),p)),p.saveStorageInfo=(()=>(i(v),t.saveAllCookie("pickup",v,"","0","0",v.split(",")[0]),p)),p);return o.checkEl=(()=>s.classList.contains("delivery-pickup__point")?(s.classList.contains("delivery-pickup__point--active")?p().setFastExit(!0).setSelected(!0):p().setPrevEl(r.querySelector(".delivery-pickup__point--active")),o):(p().setFastExit(!0),o)),o.saveInfo=(()=>c?(p().clearSavedInfo().clearChosenPoint(),o):(n||p().setChosenPoint().saveStorageInfo(),o)),o.setStatus=(()=>(n||t.handleClass(s,"add","delivery-pickup__point--active"),c&&t.handleClass(s,"remove","delivery-pickup__point--active"),d&&t.handleClass(d,"remove","delivery-pickup__point--active"),o)),o};o(e).checkEl().saveInfo().setStatus()}),p=(()=>{const i=()=>(i.restorePoints=(()=>([...r.children].forEach(e=>t.handleClass(e,"remove","hidden")),i)),i.hide=(()=>(t.handleClass(l,"add","hidden"),i)),i.inputClear=(()=>(e.value="",i)),i.removeListeners=(()=>(h.forEach(e=>((e,t,i)=>e.removeEventListener(t,i))(e[0],e[1],e[2])),i)),i.disableBlockScreen=(()=>(t.handleClass(blockScreen,"add","hidden"),i)),i.blockConfirmButton=(()=>i),i.callCustomEvent=(()=>(l.dispatchEvent(customEvent),i)),i);i().hide().restorePoints().inputClear().removeListeners().blockConfirmButton().disableBlockScreen().callCustomEvent()}),()=>{const e=()=>(e.closeModule=(()=>(p(),e)),e.saveInfo=(()=>(i(v),e)),e);e().saveInfo().closeModule()},o)),o.add=(()=>(h=[[e,"input",d],[r,"click",c]],h.forEach(e=>((e,t,i)=>e.addEventListener(t,i))(e[0],e[1],e[2])),o)),o};r(e).initiate(),o(e).create().add()})(_.extend(e,{pointsWrapper:e.pickupModule.querySelector(".delivery-pickup__points-list"),input:e.pickupModule.querySelector(".delivery-pickup__input"),deliveryPoints:{city:["Ярославль","Москва","Астрахань","Оренбург","Бузулук","Химки","Санкт-Петербург","Горький","Одесса","Мурманск","Алма-Ата"],address:["Полушкина Роща 16Л","Пушкина 30","Власова 61б","Зелинского 10","Соловьёва 90","Babel 76","Fallout 77","Королёва 35","Бурмистрова 16","Сидорова 47/4","Кирова 11"]}}))}),window.deliverySelfExport=(()=>{const e={selfExportModule:document.querySelector(".delivery-selfExport"),JCShiptorWidgetPvz:document.querySelector("#shiptor_widget_pvz"),map:document.querySelector('[data-role="shiptor_widget_show"]')};(e=>{const t={saveAllCookie:(e,t,i,r,o)=>{const l=["deliveryType","deliveryAddress","selfExportPointId","deliveryDeadline","deliveryCost"];[e,t,i,r,o].forEach((e,t)=>saveCookie(l[t],e))},checkAvailable:(e,t="")=>e||t,getText:e=>e?e.textContent:"",initiateApi:(e,t="77000000000")=>new ShiptorPointsGetter({usersCity:e,fromCity:t}),handleClass:(e,t,i)=>e.classList[t](i),hasClass:(e,t)=>e.classList.contains(t),escapeHtml:e=>{const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,e=>t[e])},activateButton:(e,i="delivery-selfExport__confirm-btn--deactive")=>{e.disabled=!1,t.handleClass(e,"remove",i)},disableButton:(e,i="delivery-selfExport__confirm-btn--deactive")=>{e.disabled=!0,t.handleClass(e,"add",i)},setDataSet:(e,t,i)=>e.dataset[t]=i,getDataSet:(e,t)=>e.dataset[t],clearEl:e=>e.innerHTML="",clearInput:e=>e.value="",removeEl:e=>null,hide:e=>t.handleClass(e,"add","hidden"),show:e=>t.handleClass(e,"remove","hidden"),hideAll:e=>[...e].forEach(t.hide),showAll:e=>[...e].forEach(t.show),setText:(e,t)=>e.textContent=t,eventAdd:(e,t,i)=>e.addEventListener(t,i),eventRemove:(e,t,i)=>e.removeEventListener(t,i),isMatch:(e,t)=>e===t,removeListOfEvents:(e,i)=>{e.filter(e=>e[i]).forEach(e=>t.eventRemove(e.el,e.ev,e.listener))},addListOfEvents:(e,i)=>{e.filter(e=>e[i]).forEach(e=>t.eventAdd(e.el,e.ev,e.listener))},setWaitScreen:()=>t.show(e.waitScreen),disableWaitScreen:()=>t.hide(e.waitScreen),lowerCase:e=>e.toLowerCase(),checkSubString:(e="",t="")=>{if(!e||!t)return null;e=e.toLowerCase().split("").sort().join("").trim().split("");let i=[];return(t=t.toLowerCase().split("").sort().join("").trim().split("")).forEach(t=>{let r="";(r=e.find(e=>e===t))&&(e.splice(1,e.indexOf(r)),i.push(r))}),i.sort().join()===t.join()},showError:()=>t.show(e.errorSection),hideError:()=>t.hide(e.errorSection),clearStorage:e=>e.forEach(e=>localStorage.setItem(e,"")),filterList:({itemList:e,childClassName:i,wrapper:r,fastExit:o,isCityFiltered:l,firstInitiate:s=!0})=>n=>{const a=t.escapeHtml(n.target.value),d=n=>{let a;return d.initiate=(()=>(s&&(e="pickup"===e?r.querySelector(".delivery-selfExport__pickup-list"):r.querySelector(".delivery-selfExport__cities-list")),s=!1,d)),d.getAllPoints=(()=>(a=[...e.querySelectorAll(i)],d)),d.inputString=(()=>3>n.length?l?(d.filterPoints("remove"),l=!1,o=!0,d):(o=!0,d):(n=t.lowerCase(n),d)),d.filterPoints=((e="add")=>o?d:(a.forEach(i=>{const{value:r}=i.dataset;return t.checkSubString(r,n)?void t.handleClass(i,"remove","hidden"):(t.handleClass(i,e,"hidden"),void(l=!0))}),d)),d.clearClosure=(()=>(o="",d)),d};d(a).initiate().getAllPoints().inputString().filterPoints().clearClosure()}},i={onChangeCity:()=>{},onShowMapClick:()=>{},onPickupConfirm:()=>{},onPickupInput:()=>{},onPickupPointClick:()=>{},onCloseClick:()=>{},onMapClose:()=>{}},r=(e,i,r)=>{localStorage.setItem("deliveryDate",t.getDataSet(e,"deliveryPeriod")),localStorage.setItem("deliveryAddress",`delivery: ${i} | ${r}`)},o=({result:{methods:e}})=>{let t,i;try{t=e[0].min_days}catch({message:e}){console.log(e),t=0}try{i=e[0].max_days}catch({message:e}){console.log(e),i=0}return[t,i]},l=({selfExportModule:e,pickupList:i,chosenCity:r,pickupSection:s,pickupSearchInput:n,JCShiptorWidgetPvz:a})=>(l.initiate=(()=>{const l=()=>{let d,c,p,u,h,v=!1,y=+localStorage.getItem("needRerender");return l.showPickupSection=(()=>(t.show(s),l)),l.setWaitScreen=(()=>(t.setWaitScreen(),l)),l.getUserCity=(()=>(d=r.textContent,l)),l.setUserCity=(()=>(d?c=d:(c=getCookie("deliveryCity")||YMaps.location.city||"Москва",t.setText(r,c)),l)),l.checkRender=(()=>{const i=()=>(i.getRenderedPoints=(()=>(v=t.getDataSet(e,"renderedPoints"),i)),i.getRenderedCity=(()=>(d!==t.getDataSet(e,"renderedCity")&&(d=""),i)),i.setRenderedCity=(()=>(t.setDataSet(e,"renderedCity",c),i)),i);return i().getRenderedCity().getRenderedPoints().setRenderedCity(),l}),l.handleDeliveryPoints=(()=>{if(!v||!d||y){const r=()=>(r.clearLocalRerenderInfo=(()=>(localStorage.setItem("needRerender",""),y=!1,r)),r.cleaPickupInput=(()=>(t.clearInput(n),r)),r.clearPickupList=(()=>(t.clearEl(i),r)),r.initiateApi=(()=>(u=t.initiateApi(c,"77000000000"),r)),r.handleRequest=(()=>{u.getUsersCityKladr().then(i=>{let r;try{r=i.result[0].kladr_id}catch({message:e}){console.log(e),r="11001110011"}return t.setDataSet(e,"cityKladr",r),r}).then(e=>t.setDataSet(a,"cityKladr",e)).then(e=>r.setKladrId(e)).then(()=>window.JCShiptorWidgetPvz.hide()).then(()=>u.calculateShipping()).then(i=>{const[r,l]=o(i);h=[r+0,l+0],t.setDataSet(e,"deliveryPeriod",l||r)}).then(()=>{u.getDeliveryPoints().then(e=>(1>e.result.length&&t.showError(),r.filterPoints(e))).then(()=>{t.setDataSet(e,"renderedPoints",1),l.checkRender(),d=c}).then(()=>l.disableWaitScreen())})}),r.filterPoints=(({result:e})=>(p=e.filter(e=>e.active),r.renderDeliveryPoints(p),r)),r.renderDeliveryPoints=(e=>{const r=document.createDocumentFragment();e.forEach(e=>{r.append((({courier:e,address:i,work_schedule:r,prepare_address:o,id:l})=>{const s=((e,t)=>{let i,r,o;try{o="object"==typeof(e=e||t)?`${i=e.street} ${r=e.house}`:`${(o=(o=t).split(", "))[1]} ${o[2]}`}catch(e){}return o})(o,i);r=t.checkAvailable(r);const n=document.createElement("li");t.handleClass(n,"add","delivery-selfExport__pickup-point"),t.setDataSet(n,"value",s),t.setDataSet(n,"id",l);const a=document.createElement("p");t.handleClass(a,"add","delivery-selfExport__address"),t.setText(a,i);const d=document.createElement("p");t.handleClass(d,"add","delivery-selfExport__work-schedule"),t.setText(d,r);const c=document.createElement("p");t.handleClass(c,"add","delivery-selfExport__shipping-days"),t.setText(c,`Срок доставки: ${h[0]} - ${h[1]} дней`);const p=document.createElement("p");return t.handleClass(p,"add","delivery-selfExport__courier"),t.setText(p,e),n.append(p),n.append(a),n.append(d),n.append(c),n})(e))}),i.append(r)}),r.setKladrId=(e=>(window.JCShiptorWidgetPvz.setParams({location:{kladr_id:e}}),window.JCShiptorWidgetPvz.refresh(),r)),r);return r().clearLocalRerenderInfo().cleaPickupInput().clearPickupList().initiateApi().handleRequest(),l}return l.disableWaitScreen(),l}),l.disableWaitScreen=(async()=>(await t.disableWaitScreen(),l)),l};l().showPickupSection().setWaitScreen().getUserCity().setUserCity().checkRender().handleDeliveryPoints()}),l),s=({changeCity:e,showMap:o,pickupSection:l,cities:n,citiesList:a,selfExportModule:d,citiesSection:c,pickupSearchInput:p,pickupList:u,JCShiptorWidgetPvz:h,map:v})=>{let y=[],C=`${d.dataset.renderedCity}, ${d.dataset.deliveryPoint}`||"",f=t.getText(u.querySelector(".delivery-selfExport__pickup-point--active .delivery-selfExport__courier")),S=new Event("ClosePickupModule",{bubbles:!0});return s.create=(()=>(i.onChangeCity=(()=>{location.assign("/kontakty.html")}),i.onPickupInput=_.partial(t.filterList,{itemList:"pickup",childClassName:".delivery-selfExport__pickup-point",wrapper:d}),i.onPickupInput=_.debounce(i.onPickupInput(),300),i.onPickupPointClick=(e=>{const i=({target:e})=>{let o,l,s;const n=()=>(n.setFastExit=(e=>(o=e,n)),n.setSelected=(e=>(s=e,n)),n.setPrevEl=(e=>(l=e,n)),n.clearSavedInfo=(()=>(t.setDataSet(d,"deliveryPoint",""),t.clearStorage(["deliveryDate","deliveryAddress"]),t.saveAllCookie("","","","",""),n)),n.clearChosenPoint=(()=>(t.removeEl(void 0),n)),n.setChosenPoint=(()=>(C=e.querySelector(".delivery-selfExport__address").textContent,f=e.querySelector(".delivery-selfExport__courier").textContent,t.setDataSet(d,"deliveryPoint",t.getDataSet(e,"value")),n)),n.setStorageInfo=(()=>(r(d,C,f),t.saveAllCookie("selfExport",C,t.getDataSet(e,"id"),d.dataset.deliveryPeriod,window.citiesList[0].price),n)),n);return i.checkEl=(()=>{const r=t.lowerCase(e.tagName);return"li"!==r&&"p"!==r?(n().setFastExit(!0),i):("p"===r&&(e=e.parentElement),e.classList.contains("delivery-selfExport__pickup-point--active")?n().setFastExit(!0).setSelected(!0):n().setPrevEl(u.querySelector(".delivery-selfExport__pickup-point--active")),i)}),i.saveInfo=(()=>s?(n().clearSavedInfo().clearChosenPoint(),i):(o||n().setChosenPoint().setStorageInfo(),i)),i.setStatus=(()=>(o||t.handleClass(e,"add","delivery-selfExport__pickup-point--active"),s&&t.handleClass(e,"remove","delivery-selfExport__pickup-point--active"),l&&t.handleClass(l,"remove","delivery-selfExport__pickup-point--active"),i)),i};i(e).checkEl().saveInfo().setStatus()}),i.onCloseClick=(()=>{const e=()=>(e.restorePoints=(()=>([...u.children].forEach(e=>t.handleClass(e,"remove","hidden")),e)),e.hide=(()=>([d,l,c].forEach(t.hide),e)),e.inputClear=(()=>(p.value="",e)),e.showAllCities=(()=>(t.showAll(a.children),e)),e.removeListeners=(()=>(t.removeListOfEvents(y,"closeModule"),e)),e.callCustomEvent=(()=>(d.dispatchEvent(S),e)),e);e().hide().restorePoints().inputClear().showAllCities().removeListeners().callCustomEvent()}),i.onPickupConfirm=(()=>{r(d,C,f),i.onCloseClick()}),i.onShowMapClick=(()=>{const e=()=>(e.mapCall=(()=>(v.click(),e)),e);e().mapCall()}),i.onMapClose=(e=>{const r=()=>(r.handleData=(({detail:{address:e}})=>{const o=()=>{let r;return o.handleGettedAddress=(()=>(e=t.lowerCase(e),o)),o.getChosenPickupFromList=(()=>(r=[...u.children].filter(i=>{const r=t.lowerCase(i.querySelector(".delivery-selfExport__address").textContent);return t.isMatch(r,e)}),o)),o.handleChosenPoint=(()=>r?(r=r[0],i.onPickupPointClick({target:r}),o):void alert("Автоматически пункт выдачи не найден :( \n Попробуйте самостоятельно найти в списке")),o.sortPickupList=(()=>(r.remove(),u.prepend(r),o)),o.clearPreviousSearch=(()=>(i.onPickupInput({target:{value:""}}),o)),o};return o().handleGettedAddress().getChosenPickupFromList().handleChosenPoint().sortPickupList().clearPreviousSearch(),r}),r);r().handleData(e)}),s)),s.listInitiate=(()=>(y=[{el:e,ev:"click",listener:i.onChangeCity,changeCityRemove:!0,cityConfirmAdd:!0,boot:!0},{el:o,ev:"click",listener:i.onShowMapClick,changeCityRemove:!0,cityConfirmAdd:!0,boot:!0},{el:p,ev:"input",listener:i.onPickupInput,changeCityRemove:!0,cityConfirmAdd:!0,boot:!0},{el:u,ev:"click",listener:i.onPickupPointClick,changeCityRemove:!0,cityConfirmAdd:!0,boot:!0},{el:h,ev:"onPvzSelect",listener:i.onMapClose,boot:!0}],s)),s.add=(()=>(t.addListOfEvents(y,"boot"),s)),s};l(e).initiate(),s(e).create().listInitiate().add()})(_.extend(e,{citiesList:e.selfExportModule.querySelector(".delivery-selfExport__cities-list"),pickupList:e.selfExportModule.querySelector(".delivery-selfExport__pickup-list"),pickupSection:e.selfExportModule.querySelector(".delivery-selfExport__pickup"),citiesSection:e.selfExportModule.querySelector(".delivery-selfExport__cities"),citySearchInput:e.selfExportModule.querySelector(".delivery-selfExport__city-search-input"),pickupSearchInput:e.selfExportModule.querySelector(".delivery-selfExport__pickup-search-input"),errorSection:e.selfExportModule.querySelector(".delivery-selfExport__error"),waitScreen:e.selfExportModule.querySelector(".delivery-selfExport__wait-screen"),chosenCity:e.selfExportModule.querySelector(".delivery-selfExport__chosen-city"),changeCity:e.selfExportModule.querySelector(".delivery-selfExport__change-city"),showMap:e.selfExportModule.querySelector(".delivery-selfExport__show-map")}))});